<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kindo Weather</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Modern Dark Theme */
        :root { 
            --bg: #121212; 
            --card: #1e1e1e; 
            --text: #ffffff; 
            --accent: #4facfe; 
            --pressure: #bb86fc; 
            --gray: #aaaaaa; 
            --hover: #2c2c2c;
            --hot: #ff6b6b;
            --cold: #4facfe;
            --sun: #f6d365;
        }
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            padding: 20px; 
            text-align: center; 
        }
        
        /* Dashboard Layout */
        .container { max-width: 600px; margin: 0 auto; }
        
        /* The Big "Current Temp" Card */
        .weather-card { 
            background-color: var(--card); 
            border-radius: 20px; 
            padding: 30px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            transition: transform 0.2s ease;
        }

        .location-title {
            font-size: 28px; 
            color: var(--text); 
            font-weight: 600;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Sky Condition Section */
        .sky-condition {
            font-size: 20px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .sky-icon { font-size: 32px; }
        
        .temp-big { 
            font-size: 80px; 
            font-weight: 200; 
            margin: 5px 0 0 0; 
            letter-spacing: -2px; 
            line-height: 1;
            /* Flexbox to keep unit aligned */
            display: flex;
            justify-content: center;
            align-items: baseline;
        }

        .temp-small {
            font-size: 24px;
            color: var(--gray);
            font-weight: 300;
            margin-bottom: 20px;
        }
        
        /* Updated Unit Style */
        .unit { 
            font-size: 80px; /* Same size as temp */
            color: var(--gray); 
            font-weight: 200;
            margin-left: 5px;
        }
        
        .details { 
            display: grid; 
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px; 
            border-top: 1px solid #333; 
            padding-top: 20px; 
        }
        
        .detail-item span { 
            display: block; 
            font-size: 12px; 
            color: var(--gray); 
            margin-bottom: 5px; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .detail-item strong { font-size: 18px; }

        .high-temp { color: var(--hot); }
        .low-temp { color: var(--cold); }
        .sun-time { color: var(--sun); }

        /* The Chart Container */
        .chart-container { 
            background-color: var(--card); 
            border-radius: 20px; 
            padding: 15px; 
            height: 340px; 
            position: relative;
            margin-bottom: 20px; 
        }
        
        .chart-title {
            color: var(--gray);
            font-size: 14px;
            font-weight: 500;
            margin: 5px 0 15px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Status Text & Controls */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            color: #555;
            font-size: 12px;
            padding: 0 10px;
            margin-bottom: 40px;
        }

        button.refresh-btn {
            background: var(--card);
            border: 1px solid #333;
            color: var(--accent);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        button.refresh-btn:hover {
            background: var(--hover);
            border-color: var(--accent);
        }

        button.refresh-btn:active {
            transform: scale(0.95);
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="weather-card">
            <div class="location-title">Current Conditions in Kindersley</div>
            
            <div id="sky-display" class="sky-condition">
                <span id="sky-icon" class="sky-icon"></span>
                <span id="sky-text">...</span>
            </div>

            <div id="date-display" style="color: var(--accent); font-weight: bold; margin-bottom: 10px; font-size: 1rem;">INITIALIZING...</div>
            
            <div class="temp-big">
                <span id="temp">--</span><span class="unit">Â°C</span>
            </div>
            <div class="temp-small" id="temp-f">--Â°F</div>
            
            <div class="details">
                <div class="detail-item">
                    <span>24h High</span>
                    <strong id="high-24" class="high-temp">--Â°C</strong>
                </div>
                <div class="detail-item">
                    <span>24h Low</span>
                    <strong id="low-24" class="low-temp">--Â°C</strong>
                </div>

                <div class="detail-item">
                    <span>Humidity</span>
                    <strong id="humid">--%</strong>
                </div>
                <div class="detail-item">
                    <span>Pressure (kPa)</span>
                    <strong id="press">--</strong>
                </div>

                <div class="detail-item">
                    <span>Sunrise</span>
                    <strong id="sunrise" class="sun-time">--:--</strong>
                </div>
                <div class="detail-item">
                    <span>Sunset</span>
                    <strong id="sunset" class="sun-time">--:--</strong>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">24 Hour Temperature Trend</h3>
            <div style="height: 280px; width: 100%;">
                <canvas id="weatherChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">24 Hour Pressure Trend</h3>
            <div style="height: 280px; width: 100%;">
                <canvas id="pressureChart"></canvas>
            </div>
        </div>

        <div class="status-bar">
            <div id="last-updated">Waiting for data...</div>
            <button class="refresh-btn" onclick="refreshAll()">â†» Refresh</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const scriptURL = "https://script.google.com/macros/s/AKfycbxEPVT6M3sImboFp8V6xo7tElaTzZ3As8PZxFxwm4NQkYyILhzdnUe7OevS3fqSXw/exec"; 
        const ELEVATION_METERS = 675; 
        const externalWeatherURL = "https://api.open-meteo.com/v1/forecast?latitude=51.467&longitude=-109.157&current=weather_code,is_day&daily=sunrise,sunset&timezone=auto";
        // ---------------------

        function calculatePressureKPa(rawHPa, tempC) {
            const seaLevelPressHPa = rawHPa * Math.pow(1 - (0.0065 * ELEVATION_METERS) / (tempC + (0.0065 * ELEVATION_METERS) + 273.15), -5.257);
            return seaLevelPressHPa / 10;
        }

        async function refreshAll() {
            const refreshBtn = document.querySelector('.refresh-btn');
            refreshBtn.innerText = "Loading...";
            refreshBtn.classList.add('loading');

            await Promise.all([fetchInternalData(), fetchExternalData()]);

            refreshBtn.innerText = "â†» Refresh";
            refreshBtn.classList.remove('loading');
        }

        async function fetchInternalData() {
            const dateDisplay = document.getElementById('date-display');
            
            try {
                dateDisplay.innerText = "UPDATING...";
                const response = await fetch(scriptURL);
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length === 0) throw new Error("No data");

                const oneDayAgo = new Date().getTime() - (24 * 60 * 60 * 1000);
                const last24HoursData = data.filter(d => new Date(d.date).getTime() > oneDayAgo);
                const historyToUse = last24HoursData.length > 0 ? last24HoursData : data;

                const current = historyToUse[historyToUse.length - 1];
                const tempC = parseFloat(current.temp);
                const tempF = (tempC * 9/5) + 32;
                
                const rawPressHPa = parseFloat(current.press);
                const pressKPa = calculatePressureKPa(rawPressHPa, tempC);

                const temps24h = historyToUse.map(d => parseFloat(d.temp));
                const high24 = Math.max(...temps24h);
                const low24 = Math.min(...temps24h);

                document.getElementById('temp').innerText = tempC.toFixed(1);
                document.getElementById('temp-f').innerText = tempF.toFixed(1) + "Â°F";
                document.getElementById('high-24').innerText = high24.toFixed(1) + "Â°C";
                document.getElementById('low-24').innerText = low24.toFixed(1) + "Â°C";
                document.getElementById('humid').innerText = parseFloat(current.humid).toFixed(0) + "%";
                document.getElementById('press').innerText = pressKPa.toFixed(2); 
                
                const dateObj = new Date(current.date);
                dateDisplay.innerText = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('last-updated').innerText = "Last Sync: " + new Date().toLocaleTimeString();

                updateTempChart(historyToUse);
                updatePressureChart(historyToUse);

            } catch (error) {
                console.error("Internal Data Error:", error);
                dateDisplay.innerText = "OFFLINE";
            }
        }

        async function fetchExternalData() {
            try {
                const response = await fetch(externalWeatherURL);
                const data = await response.json();

                const code = data.current.weather_code;
                const isDay = data.current.is_day;
                const condition = getWeatherDescription(code);
                
                document.getElementById('sky-text').innerText = condition.text;
                document.getElementById('sky-icon').innerText = isDay ? condition.icon : condition.nightIcon || condition.icon;

                const sunriseTime = new Date(data.daily.sunrise[0]).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const sunsetTime = new Date(data.daily.sunset[0]).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                document.getElementById('sunrise').innerText = sunriseTime;
                document.getElementById('sunset').innerText = sunsetTime;

            } catch (error) {
                console.error("External Data Error:", error);
                document.getElementById('sky-text').innerText = "--";
            }
        }

        function getWeatherDescription(code) {
            const codes = {
                0: { text: "Clear Sky", icon: "â˜€ï¸", nightIcon: "ðŸŒ™" },
                1: { text: "Mainly Clear", icon: "ðŸŒ¤ï¸", nightIcon: "â˜ï¸" },
                2: { text: "Partly Cloudy", icon: "â›…", nightIcon: "â˜ï¸" },
                3: { text: "Overcast", icon: "â˜ï¸" },
                45: { text: "Foggy", icon: "ðŸŒ«ï¸" },
                48: { text: "Rime Fog", icon: "ðŸŒ«ï¸" },
                51: { text: "Light Drizzle", icon: "DRIZZLE" },
                53: { text: "Drizzle", icon: "ðŸŒ§ï¸" },
                55: { text: "Heavy Drizzle", icon: "ðŸŒ§ï¸" },
                61: { text: "Light Rain", icon: "ðŸŒ¦ï¸" },
                63: { text: "Rain", icon: "ðŸŒ§ï¸" },
                65: { text: "Heavy Rain", icon: "ðŸŒ§ï¸" },
                71: { text: "Light Snow", icon: "ðŸŒ¨ï¸" },
                73: { text: "Snow", icon: "â„ï¸" },
                75: { text: "Heavy Snow", icon: "â„ï¸" },
                77: { text: "Snow Grains", icon: "â„ï¸" },
                80: { text: "Light Showers", icon: "ðŸŒ¦ï¸" },
                81: { text: "Showers", icon: "ðŸŒ§ï¸" },
                82: { text: "Heavy Showers", icon: "â›ˆï¸" },
                95: { text: "Thunderstorm", icon: "âš¡" },
                96: { text: "Thunderstorm", icon: "âš¡" },
                99: { text: "Thunderstorm", icon: "âš¡" }
            };
            return codes[code] || { text: "Unknown", icon: "â“" };
        }

        // --- Chart Objects ---
        let myTempChart;
        let myPressureChart;

        // Custom Plugin to Draw the "Freezing Line" at 0
        const freezingLinePlugin = {
            id: 'freezingLine',
            beforeDraw: (chart) => {
                const { ctx, scales: { y } } = chart;
                const zeroY = y.getPixelForValue(0);

                // Only draw if 0 is within the visible area
                if (zeroY >= y.top && zeroY <= y.bottom) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(chart.chartArea.left, zeroY);
                    ctx.lineTo(chart.chartArea.right, zeroY);
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)'; // Bright line
                    ctx.setLineDash([5, 5]); // Dashed line
                    ctx.stroke();
                    ctx.restore();
                }
            }
        };

        function updateTempChart(data) {
            const ctx = document.getElementById('weatherChart').getContext('2d');
            const labels = data.map(d => new Date(d.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            const temps = data.map(d => parseFloat(d.temp));
            
            // Calculate Min/Max for Dynamic Range (Min - 10, Max + 10)
            const maxVal = Math.max(...temps);
            const minVal = Math.min(...temps);

            if (myTempChart) myTempChart.destroy();

            myTempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperature (Â°C)',
                        data: temps,
                        borderColor: '#4facfe',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(79, 172, 254, 0.4)');
                            gradient.addColorStop(1, 'rgba(79, 172, 254, 0.0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHitRadius: 10,
                        pointBackgroundColor: '#1e1e1e',
                        pointBorderColor: '#4facfe',
                    }]
                },
                plugins: [freezingLinePlugin], // Add the zero line plugin
                options: {
                    ...createChartOptions('Temperature (Â°C)'),
                    scales: {
                        x: { 
                            display: true,
                            title: { display: true, text: 'Time', color: '#555', font: { size: 12 } },
                            grid: { display: false },
                            ticks: { color: '#888', maxRotation: 0, maxTicksLimit: 7 }
                        }, 
                        y: { 
                            display: true,
                            min: minVal - 10, // Padding bottom
                            max: maxVal + 10, // Padding top
                            title: { display: true, text: 'Temperature (Â°C)', color: '#555', font: { size: 12 } },
                            grid: { color: '#333', borderDash: [5, 5] }, 
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function updatePressureChart(data) {
            const ctx = document.getElementById('pressureChart').getContext('2d');
            const labels = data.map(d => new Date(d.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            const pressures = data.map(d => calculatePressureKPa(parseFloat(d.press), parseFloat(d.temp)));

            if (myPressureChart) myPressureChart.destroy();

            myPressureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pressure (kPa)',
                        data: pressures,
                        borderColor: '#bb86fc', 
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(187, 134, 252, 0.4)');
                            gradient.addColorStop(1, 'rgba(187, 134, 252, 0.0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHitRadius: 10,
                        pointBackgroundColor: '#1e1e1e',
                        pointBorderColor: '#bb86fc',
                    }]
                },
                options: {
                    ...createChartOptions('Pressure (kPa)'),
                    scales: {
                        x: { 
                            display: true,
                            title: { display: true, text: 'Time', color: '#555', font: { size: 12 } },
                            grid: { display: false },
                            ticks: { color: '#888', maxRotation: 0, maxTicksLimit: 7 }
                        }, 
                        y: { 
                            display: true,
                            min: 98,  // Adjusted for better visibility
                            max: 105, 
                            title: { display: true, text: 'Pressure (kPa)', color: '#555', font: { size: 12 } },
                            grid: { color: '#333', borderDash: [5, 5] }, 
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function createChartOptions(yAxisTitle) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1e1e1e',
                        titleColor: '#fff',
                        bodyColor: '#aaa',
                        borderColor: '#333',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: false,
                        callbacks: {
                            label: function(context) { return context.parsed.y.toFixed(2) + ' ' + (yAxisTitle.includes('Temp') ? 'Â°C' : 'kPa'); }
                        }
                    }
                }
            };
        }

        window.addEventListener('load', refreshAll);
        setInterval(refreshAll, 300000); 

    </script>
</body>
</html>
